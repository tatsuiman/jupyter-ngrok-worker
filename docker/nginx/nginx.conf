worker_processes  1;

events {
    worker_connections  1024;
}

http {
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }
    # カスタムログフォーマットの定義
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;


    server {
        listen 80;

        # リクエストヘッダーからX-Forwarded-Forを取得し、プロキシ設定
        set_real_ip_from 0.0.0.0/0;  # 信頼できるプロキシからのIPをすべて設定
        real_ip_header X-Forwarded-For;

        location / {
            proxy_pass http://jupyter:8888;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	    # AWS ap-northeast-1 IP Range
            allow 3.112.0.0/14;
            allow 3.112.0.0/14;
            allow 3.112.162.0/23;
            allow 3.112.23.0/29;
            allow 3.112.64.0/23;
            allow 3.112.85.96/27;
            allow 3.112.96.0/26;
            allow 3.112.96.128/27;
            allow 3.112.96.160/27;
            allow 3.112.96.64/26;
            allow 3.113.218.0/26;
            allow 3.113.218.112/28;
            allow 3.113.218.128/27;
            allow 3.113.218.68/30;
            allow 3.113.218.72/30;
            allow 3.113.218.76/30;
            allow 3.114.164.0/22;
            allow 3.5.152.0/21;
            allow 3.5.152.0/21;
            allow 3.5.152.0/21;
            allow 13.112.0.0/14;
            allow 13.112.0.0/14;
            allow 13.112.191.184/29;
            allow 13.113.196.64/26;
            allow 13.113.203.0/24;
            allow 13.113.244.25/32;
            allow 13.192.0.0/13;
            allow 13.230.0.0/15;
            allow 13.230.0.0/15;
            allow 13.230.21.128/26;
            allow 13.230.21.224/28;
            allow 13.230.21.240/28;
            allow 13.231.6.104/29;
            allow 13.231.6.112/28;
            allow 13.231.6.192/28;
            allow 13.231.6.208/29;
            allow 13.231.6.64/29;
            allow 13.231.6.72/29;
            allow 13.231.6.80/29;
            allow 13.231.6.88/29;
            allow 13.248.115.0/24;
            allow 13.248.115.0/24;
            allow 13.248.69.0/24;
            allow 13.248.69.0/24;
            allow 13.248.70.0/24;
            allow 13.248.70.0/24;
            allow 13.248.98.0/24;
            allow 13.248.98.0/24;
            allow 13.34.0.128/27;
            allow 13.34.0.160/27;
            allow 13.34.112.192/27;
            allow 13.34.112.224/27;
            allow 13.34.112.64/27;
            allow 13.34.112.96/27;
            allow 13.34.113.0/27;
            allow 13.34.113.32/27;
            allow 13.34.15.0/27;
            allow 13.34.15.32/27;
            allow 13.34.46.128/27;
            allow 13.34.46.160/27;
            allow 13.34.46.192/27;
            allow 13.34.46.224/27;
            allow 13.34.53.160/27;
            allow 13.34.53.192/27;
            allow 13.34.58.192/27;
            allow 13.34.58.224/27;
            allow 13.34.62.128/27;
            allow 13.34.62.160/27;
            allow 13.34.69.0/27;
            allow 13.34.69.32/27;
            allow 13.34.69.64/27;
            allow 13.34.69.96/27;
            allow 13.34.85.64/27;
            allow 13.34.85.96/27;
            allow 13.34.87.128/27;
            allow 13.34.87.160/27;
            allow 13.34.87.64/27;
            allow 13.34.87.96/27;
            allow 15.177.79.0/24;
            allow 15.177.79.0/24;
            allow 15.177.79.0/24;
            allow 15.193.1.0/24;
            allow 15.193.1.0/24;
            allow 15.220.56.0/21;
            allow 15.220.56.0/21;
            allow 15.220.80.0/20;
            allow 15.220.80.0/20;
            allow 15.221.152.0/24;
            allow 15.221.34.0/24;
            allow 15.230.129.0/24;
            allow 15.230.152.0/24;
            allow 15.230.154.0/23;
            allow 15.230.160.0/24;
            allow 15.230.161.0/24;
            allow 15.230.59.0/24;
            allow 15.230.76.192/26;
            allow 15.230.77.0/26;
            allow 15.230.77.64/26;
            allow 15.230.99.0/24;
            allow 18.176.0.0/15;
            allow 18.176.0.0/15;
            allow 18.176.203.120/30;
            allow 18.177.156.192/26;
            allow 18.178.0.0/16;
            allow 18.178.0.0/16;
            allow 18.179.0.0/16;
            allow 18.179.0.0/16;
            allow 18.179.48.128/27;
            allow 18.179.48.96/27;
            allow 18.180.0.0/15;
            allow 18.180.0.0/15;
            allow 18.180.178.0/24;
            allow 18.180.180.0/23;
            allow 18.180.88.0/23;
            allow 18.181.204.128/26;
            allow 18.181.204.192/26;
            allow 18.181.242.0/23;
            allow 18.182.0.0/16;
            allow 18.182.0.0/16;
            allow 18.182.96.64/26;
            allow 18.183.0.0/16;
            allow 18.183.0.0/16;
            allow 18.183.37.0/26;
            allow 27.0.0.0/22;
            allow 35.71.114.0/24;
            allow 35.71.114.0/24;
            allow 35.71.114.0/24;
            allow 35.72.0.0/13;
            allow 35.72.0.0/13;
            allow 35.72.164.212/30;
            allow 35.72.164.232/29;
            allow 35.72.164.240/28;
            allow 35.72.255.0/24;
            allow 35.72.36.140/31;
            allow 35.72.36.142/31;
            allow 35.72.36.144/30;
            allow 35.72.36.148/30;
            allow 35.72.36.192/27;
            allow 35.72.36.224/27;
            allow 35.72.37.0/25;
            allow 35.72.37.128/25;
            allow 35.73.0.0/22;
            allow 35.73.115.0/28;
            allow 35.73.115.128/25;
            allow 35.73.4.0/24;
            allow 35.73.8.0/22;
            allow 35.74.77.240/30;
            allow 35.75.130.0/24;
            allow 35.75.131.0/26;
            allow 35.75.131.80/29;
            allow 35.76.252.0/23;
            allow 35.77.0.128/26;
            allow 35.77.112.0/22;
            allow 35.77.124.0/23;
            allow 43.206.0.0/15;
            allow 43.206.0.0/15;
            allow 43.207.179.168/29;
            allow 43.207.179.176/29;
            allow 46.51.224.0/19;
            allow 46.51.224.0/19;
            allow 52.119.216.0/21;
            allow 52.144.225.128/26;
            allow 52.144.225.64/26;
            allow 52.144.229.64/26;
            allow 52.144.230.0/26;
            allow 52.192.0.0/15;
            allow 52.192.0.0/15;
            allow 52.194.0.0/15;
            allow 52.194.0.0/15;
            allow 52.195.198.0/23;
            allow 52.195.200.0/22;
            allow 52.196.0.0/14;
            allow 52.196.0.0/14;
            allow 52.199.127.192/26;
            allow 52.219.0.0/20;
            allow 52.219.0.0/20;
            allow 52.219.136.0/22;
            allow 52.219.136.0/22;
            allow 52.219.150.0/23;
            allow 52.219.150.0/23;
            allow 52.219.152.0/22;
            allow 52.219.152.0/22;
            allow 52.219.16.0/22;
            allow 52.219.16.0/22;
            allow 52.219.162.0/23;
            allow 52.219.162.0/23;
            allow 52.219.172.0/22;
            allow 52.219.172.0/22;
            allow 52.219.195.0/24;
            allow 52.219.195.0/24;
            allow 52.219.196.0/22;
            allow 52.219.196.0/22;
            allow 52.219.20.0/24;
            allow 52.219.20.0/24;
            allow 52.219.200.0/24;
            allow 52.219.200.0/24;
            allow 52.219.201.0/24;
            allow 52.219.201.0/24;
            allow 52.219.68.0/22;
            allow 52.219.68.0/22;
            allow 52.68.0.0/15;
            allow 52.68.0.0/15;
            allow 52.93.121.187/32;
            allow 52.93.121.188/32;
            allow 52.93.121.189/32;
            allow 52.93.121.190/32;
            allow 52.93.121.195/32;
            allow 52.93.121.196/32;
            allow 52.93.121.197/32;
            allow 52.93.121.198/32;
            allow 52.93.127.146/32;
            allow 52.93.127.147/32;
            allow 52.93.127.148/32;
            allow 52.93.127.149/32;
            allow 52.93.127.156/32;
            allow 52.93.127.157/32;
            allow 52.93.127.174/32;
            allow 52.93.127.175/32;
            allow 52.93.127.176/32;
            allow 52.93.127.177/32;
            allow 52.93.127.178/32;
            allow 52.93.127.179/32;
            allow 52.93.127.239/32;
            allow 52.93.127.244/32;
            allow 52.93.127.245/32;
            allow 52.93.127.246/32;
            allow 52.93.127.247/32;
            allow 52.93.127.248/32;
            allow 52.93.127.249/32;
            allow 52.93.127.250/32;
            allow 52.93.127.251/32;
            allow 52.93.127.252/32;
            allow 52.93.127.253/32;
            allow 52.93.127.254/32;
            allow 52.93.127.255/32;
            allow 52.93.136.0/24;
            allow 52.93.150.0/24;
            allow 52.93.245.0/24;
            allow 52.93.250.0/23;
            allow 52.93.66.0/24;
            allow 52.93.72.0/23;
            allow 52.93.95.0/24;
            allow 52.94.152.3/32;
            allow 52.94.200.0/24;
            allow 52.94.248.80/28;
            allow 52.94.248.80/28;
            allow 52.94.8.0/24;
            allow 52.94.8.0/24;
            allow 52.95.243.0/24;
            allow 52.95.243.0/24;
            allow 52.95.255.48/28;
            allow 52.95.255.48/28;
            allow 52.95.30.0/23;
            allow 52.95.34.0/24;
            allow 52.95.56.0/22;
            allow 54.150.0.0/16;
            allow 54.150.0.0/16;
            allow 54.168.0.0/16;
            allow 54.168.0.0/16;
            allow 54.178.0.0/16;
            allow 54.178.0.0/16;
            allow 54.199.0.0/16;
            allow 54.199.0.0/16;
            allow 54.238.0.0/16;
            allow 54.238.0.0/16;
            allow 54.239.0.80/28;
            allow 54.239.52.0/23;
            allow 54.239.96.0/24;
            allow 54.240.200.0/24;
            allow 54.240.225.0/24;
            allow 54.248.0.0/15;
            allow 54.248.0.0/15;
            allow 54.248.220.0/26;
            allow 54.250.0.0/16;
            allow 54.250.0.0/16;
            allow 54.250.251.0/24;
            allow 54.250.253.192/26;
            allow 54.64.0.0/15;
            allow 54.64.0.0/15;
            allow 54.92.0.0/17;
            allow 54.92.0.0/17;
            allow 54.95.0.0/16;
            allow 54.95.0.0/16;
            allow 57.180.0.0/14;
            allow 57.180.0.0/14;
            allow 57.180.138.64/26;
            allow 57.181.142.164/31;
            allow 57.181.142.168/30;
            allow 57.181.142.182/31;
            allow 57.181.142.224/31;
            allow 57.181.142.228/30;
            allow 64.252.110.0/24;
            allow 64.252.110.0/24;
            allow 64.252.111.0/24;
            allow 64.252.111.0/24;
            allow 64.252.112.0/24;
            allow 64.252.112.0/24;
            allow 64.252.113.0/24;
            allow 64.252.113.0/24;
            allow 99.150.48.0/21;
            allow 99.150.48.0/21;
            allow 99.77.139.0/24;
            allow 99.77.139.0/24;
            allow 99.77.160.0/24;
            allow 99.77.160.0/24;
            allow 99.77.244.0/24;
            allow 99.77.244.0/24;
            allow 99.77.244.0/24;
            allow 99.77.56.0/21;
            allow 99.78.208.0/22;
            allow 99.82.0.0/22;
            allow 99.82.170.0/24;
            allow 99.82.170.0/24;
            allow 99.83.84.0/22;
            allow 103.246.150.0/23;
            allow 103.4.8.0/21;
            allow 103.4.8.0/21;
            allow 104.255.59.136/32;
            allow 104.255.59.137/32;
            allow 104.255.59.81/32;
            allow 104.255.59.82/32;
            allow 104.255.59.83/32;
            allow 136.18.20.0/24;
            allow 150.222.105.0/24;
            allow 150.222.133.0/24;
            allow 150.222.141.0/24;
            allow 150.222.15.128/30;
            allow 150.222.38.0/26;
            allow 150.222.38.128/26;
            allow 150.222.38.64/26;
            allow 150.222.77.0/24;
            allow 150.222.90.0/24;
            allow 150.222.91.0/24;
            allow 151.148.37.0/24;
            allow 151.148.37.0/24;
            allow 173.83.210.0/24;
            allow 173.83.210.0/24;
            allow 175.41.192.0/18;
            allow 175.41.192.0/18;
            allow 176.32.64.0/19;
            allow 176.32.64.0/19;
            allow 176.34.0.0/19;
            allow 176.34.0.0/19;
            allow 176.34.32.0/19;
            allow 176.34.32.0/19;
            allow 208.78.130.0/23;
            allow 208.78.130.0/23;
            allow 216.39.160.0/21;
            allow 216.39.160.0/21;
	    # LAN
            allow 192.168.0.0/16;
            deny all;
            # 拒否されたリクエスト用のログ設定
            access_log /var/log/nginx/denied_access.log main;
        }
    }
}
